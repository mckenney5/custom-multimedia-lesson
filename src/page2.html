<!DOCTYPE html>
<!-- This is the first part of a lesson -->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Simple Quiz</title>
</head>
<body>
	<h1>Page 2</h1></br>
	<h2 id="question-header">Quiz</h2>
	<div id="question-area"></div>

	<script>
	//to send data to parent:
	// window.parent.functionName(parameter);
	let MAX_ATTEMPTS = 1;
	let attempts = 0;

	function submitQuiz(){
		let feedback = document.getElementById("feedback");
		if(attempts >= MAX_ATTEMPTS){
			console.log("Max attempts reached. Ignored submission");
			feedback.innerHTML = "<p>You have already submitted this quiz the max ammount of times</p>";
			feedback.style.display = "block";
			return;
		}
		attempts += 1;
		const parent = document.getElementById("question-area");
		const children = parent.querySelectorAll(":scope > div");
		const answers = {};

		for (const div of children){
			const inputs = div.querySelectorAll('input[type="checkbox"]');
			const selection = [];
			for (const input of inputs){
				if (input.checked) selection.push(input.value);
			}
			answers[div.id] = selection;
		}
		window.parent.postMessage({ type: 'QUIZ_SUBMITTED', message: answers }, '*');
	}


	function init(){
	// Sets up questions then forces a render
		// Start listening for messages like quiz rendering
		window.addEventListener('message', (event) => {
			if(event.origin != 'localhost'){
				console.error("Unknown orgin " + event.origin);
				//return;
			}

			if(event.data.type === "QUIZ_ADD_QUESTIONS"){
				document.getElementById("question-area").innerHTML = event.data.message;
			}

			if(event.data.type === "QUIZ_INFO"){
				if(!event.data.score && !event.data.maxAttempts){
					console.error(`API Error, missing required information in quiz --> score=${event.data.score} | maxAttempts=${event.data.maxAttempts}`);
					return;
				}
				MAX_ATTEMPTS = event.data.maxAttempts;
				feedback.innerHTML = `<p>You scored a ${event.data.score * 100}% and have ${event.data.maxAttempts} attempts left</p>`;
				feedback.style.display = "block";
				event.data.message;
			}
		});
		// send questions to the parent
		window.parent.postMessage({type: 'QUIZ_ADD_QUESTIONS', message: ""}, '*');
	}

	init();
	</script>

</body>
</html>
