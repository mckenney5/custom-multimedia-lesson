<!DOCTYPE html>
<!-- This is the first part of a lesson -->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Simple Quiz</title>
</head>
<body>
	<h1>Page 2</h1></br>
	<h2 id="question-header">Quiz</h2>
	<div id="question-area"></div>

	<div id="feedback" style="display: none; margin-top: 20px;">
		<p>Your answer has been submitted to the LMS. You may close this window.</p>
	</div>

	<script>
	//to send data to parent:
	// window.parent.functionName(parameter);
	class Question {
		constructor (id, text, correctAnswer, possibleAnswers, pointValue){
			this.id = id; // unique question ID
			this.text = text; // question being asked
			this.correctAnswer = correctAnswer; // the correct answer to the question, should be a list from greatest to least
			this.possibleAnswers = possibleAnswers; // this is an array of strings
			this.selectedAnswer = -1; //index of what the user selected currently
			this.pointValue = pointValue; // how many points the question is worth
		}

		isCorrect(){
		// returns true if the question is correctAnswer
			return (this.correctAnswer === this.possibleAnswers[this.selectedAnswer]);
		}

		submit(){
			if(this.isCorrect()){
				return this.pointValue;
			} else {
				return 0;
			}
		}
	}

	const MAX_ATTEMPTS = 3;
	let currentScore = null;
	let attempts = 0;
	let currentQuestionIndex = 0;

	function answer(data){
		if(data == true){
			window.parent.state.markMeComplete(1);
		} else {
			alert("Wrong!");

		}

	}
	const QUIZ_QUESTIONS = [];

	function renderAllQuestions(){
	// Puts all of the questions on the screen, in their own DIV
		let div = document.getElementById("question-area");
		let html = ``;
		for(let i = 0; i < QUIZ_QUESTIONS.length; i++){
			// Render every question in a div

			if(i % 2 == 0){
			// alternate background colors
				html += `<div id="Q${i+1}" style="background: lightgray;">`;
			} else {
				html += `<div id="Q${i+1}" style="background: white;">`;
			}

			html += `<h3 id="text">${i+1}. ${QUIZ_QUESTIONS[i].text}</h3>`;
			for(let l = 0; l < QUIZ_QUESTIONS[i].possibleAnswers.length; l++){
			// Render every choice
				html += `
					<input id="a${l}" type="checkbox" value="${QUIZ_QUESTIONS[i].possibleAnswers[l]}">
					<label id="a${l}-label" for="a${l}">${QUIZ_QUESTIONS[i].possibleAnswers[l]}</label>
					</br>
				`;
			}
			html += "</div>";
			div.insertAdjacentHTML("beforeend", html);
			html = "";
		}
		div.insertAdjacentHTML("beforeend", "</br><button onclick='submitQuiz()'>Submit</button>");
	}

	function checkAnswers(answers){
	// takes in a dict of question id and selected answers
		let totalPoints = 0;
		let score = 0;
		for(let i = 0; i < QUIZ_QUESTIONS.length; i++){
			let q = QUIZ_QUESTIONS[i];
			let a = answers[q.id].sort();
			a = JSON.stringify(a);

			let b = q.correctAnswer.sort();
			b = JSON.stringify(b);

			if(a === b){
				score += q.pointValue;
			}
			totalPoints += q.pointValue;
		}
		return parseFloat(score / totalPoints);
	}

	function submitQuiz(){
		if(attempts >= MAX_ATTEMPTS){
			console.log("Max attempts reached. Ignored submission");
			return;
		}
		attempts += 1;
		const parent = document.getElementById("question-area");
		const children = parent.querySelectorAll(":scope > div");
		const answers = {};

		for (const div of children){
			const inputs = div.querySelectorAll('input[type="checkbox"]');
			const selection = [];
			for (const input of inputs){
				if (input.checked) selection.push(input.value);
			}
			answers[div.id] = selection;
		}
		//console.log(answers);
		//console.log("Score " + checkAnswers(answers));
		//window.parent.state.markMeComplete(checkAnswers(answers));
		window.parent.postMessage({ type: 'QUIZ_SUBMITTED', score: checkAnswers(answers) }, '*');
	}


	function init(){
	// Sets up questions then forces a render
		QUIZ_QUESTIONS.push(new Question("Q1","The sky is blue", ["True"], ["True", "False"], 1.0));
		QUIZ_QUESTIONS.push(new Question("Q2","What is 1 + 1?", ["2"], ["1", "2", "3", "4"], 1.0));
		QUIZ_QUESTIONS.push(new Question("Q3","What is 1 + 2?", ["3"], ["1", "2", "3", "4"], 1.0));
		QUIZ_QUESTIONS.push(new Question("Q4","What is 2 + 1?", ["3"], ["1", "2", "3", "4"], 1.0));

		renderAllQuestions();
	}

	init();
	</script>

</body>
</html>
